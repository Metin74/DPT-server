<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>DPT 3d view</title>

    <!-- Babylon.js -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/gltf_validator.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 90%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var lastX = 0;
        var lastY = 0;
        var xxx = 0;
        var opinionanzahl = [0, 1, 2, 3, 4, 5, 6, 7, 8];//, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];

        var canvas = document.getElementById("renderCanvas");

        var createScene = function () {
            // Szene
            var scene = new BABYLON.Scene(engine);
            // scene.ambientColor = new BABYLON.Color3(1, 1, 1);

            // Skybox
            var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", { size: 1000.0 }, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            var skyboxfiles = [
                "textures/space2_left.jpg",
                "textures/space2_up.jpg",
                "textures/space2_front.jpg",
                "textures/space2_right.jpg",
                "textures/space2_down.jpg",
                "textures/space2_back.jpg",];
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture.CreateFromImages(skyboxfiles, scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;

            // Kamera
            
            var camera = new BABYLON.ArcRotateCamera("cam", -Math.PI / 2, Math.PI / 2, 50, BABYLON.Vector3.Zero());
            camera.wheelDeltaPercentage = 0.01;
            camera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 2;
            camera.upperRadiusLimit = 120;
            
            // Parameters: name, position, scene
            /*
var camera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0,0,-300), scene);

// The goal distance of camera from target
camera.radius = 30;

// The goal height of camera above local origin (centre) of target
camera.heightOffset = 10;

// The goal rotation of camera around local origin (centre) of target in x y plane
camera.rotationOffset = 180;

// Acceleration of camera in moving from current to goal position
camera.cameraAcceleration = 0.05

// The speed at which acceleration is halted
camera.maxCameraSpeed = 3

// This attaches the camera to the canvas
camera.attachControl(canvas, true);
*/


/*
	var camera = new BABYLON.ArcRotateCamera("Camera",  Math.PI / 2, -Math.PI / 2, 50, BABYLON.Vector3.Zero(), scene);
	// The goal distance of camera from target
camera.radius = 30;

// The goal height of camera above local origin (centre) of target
camera.heightOffset = 10;

// The goal rotation of camera around local origin (centre) of target in x y plane
camera.rotationOffset = 0;

// Acceleration of camera in moving from current to goal position
camera.cameraAcceleration = 0.05

// The speed at which acceleration is halted
camera.maxCameraSpeed = 3

    camera.attachControl(canvas, true);
    camera.useFramingBehavior = true;
    
*/
            // Licht
            var light1 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(1, 1, 0), scene);
            var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(0, 1, -1), scene);

            // Die Kugel ist das Zentrum der Szene (0,0,0) und 0,1 Einheit im Durchmesser
            var sphere = BABYLON.MeshBuilder.CreateSphere("sphere", { diameter: 0.1 }, scene);
            //Kameraziel
            //camera.setTarget(sphere);

            var anchor = new BABYLON.TransformNode("");

            // Create the 3D UI manager
            var uiManager = new BABYLON.GUI.GUI3DManager(scene);

            //Set font
            var font_size = 48;
            var font = "bold " + font_size + "px Arial";

            //Set height for plane
            var planeHeight = 0.2;

            //Set height for dynamic texture
            var DTHeight = 1.5 * font_size; //or set as wished

            //Calcultae ratio
            var ratio = planeHeight / DTHeight;



            //
            // Button-Adder für Topics
            var addTopic = function (i) {

                //
                // Scattert Panel für Topics
                var panelTopic = new BABYLON.GUI.ScatterPanel();
                panelTopic.margin = 8;
                uiManager.addControl(panelTopic);

                panelTopic.linkToTransformNode(anchor);
                // Ausrichten zulassen oder blocken
                panelTopic.blockLayout = false;
                // Koordinaten
                panelTopic.position.z = 0.1;

                // Topic BUTTON
                var butTopic = new BABYLON.GUI.Button3D("butTopic");
                var text = new BABYLON.GUI.TextBlock();
                text.text = "Topic #:" + i + " O: " + opinionanzahl[i];
                text.color = "white";
                text.fontSize = 18;
                butTopic.content = text;
                /*
                                if (i % 2 == 0) {
                                    butTopic.imageUrl = "picture01.png";
                                } else {
                                    butTopic.imageUrl = "picture02.png";
                                }
                */
                panelTopic.addControl(butTopic);


//NEW BUTTON


/*
// GUI
    var plane = BABYLON.Mesh.CreatePlane("plane", 2);
    plane.parent = sphere;
    plane.position.y = 2;

    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(plane);

    var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "Click Me");
    button1.width = 1;
    button1.height = 0.4;
    button1.color = "white";
    button1.fontSize = 50;
    button1.background = "green";
    button1.onPointerUpObservable.add(function() {
        alert("you did it!");
    });
    advancedTexture.addControl(button1);
    
    */

                //create a Center of Transformation
                var CoT = new BABYLON.TransformNode("root");
                butTopic.parent = CoT;  //apply to CoT

                lastX = butTopic.position.x;
                lastY = butTopic.position.y;
                // Buttonbehavior Topic
                butTopic.onPointerUpObservable.add(function () {
                    text.text = "checked!";
                    butTopic.scaling.x = 2;
                    butTopic.scaling.y = 2;
                    //butTopic.content = text;
                    //alert(butTopic.text);
                    //camera.lockedTarget = this;
                });

                // Torus um das Topic machen
                var torus = BABYLON.Mesh.CreateTorus("torusTopic", 6, 0.05, 64, scene);
                // Torus Material (random Farbe)
                var torusMat = new BABYLON.StandardMaterial("torusMat", scene);
                torusMat.diffuseColor = new BABYLON.Color3(Math.random(1), Math.random(1), Math.random(1));
                torusMat.emissiveColor = new BABYLON.Color3(0.1, 0.1, 0.1);
                torus.material = torusMat;
                torus.parent = CoT;
                // Ausrichten
                torus.rotation.x = -Math.PI / 2;
                torus.position.x = lastX;
                torus.position.y = lastY;


                // Dynamisches Textfeld
                //Set text
                var dyntext = "Topic Nummer: " + i + " Anzahl Opinions: " + opinionanzahl[i];

                //Use a temporay dynamic texture to calculate the length of the text on the dynamic texture canvas
                var temp = new BABYLON.DynamicTexture("DynamicTexture", 64, scene);
                var tmpctx = temp.getContext();
                tmpctx.font = font;
                var DTWidth = tmpctx.measureText(dyntext).width + 8;

                //Calculate width the plane has to be 
                var planeWidth = DTWidth * ratio;

                //Create dynamic texture and write the text
                var dynamicTexture = new BABYLON.DynamicTexture("DynamicTexture", { width: DTWidth, height: DTHeight }, scene, false);
                var mat = new BABYLON.StandardMaterial("mat", scene);
                mat.diffuseTexture = dynamicTexture;
                dynamicTexture.drawText(dyntext, null, null, font, "#000000", "#ffffff", true);

                //Create plane and set dynamic texture as material
                var plane = BABYLON.MeshBuilder.CreatePlane("plane", { width: planeWidth, height: planeHeight }, scene);
                plane.material = mat;
                plane.position.x = lastX;
                plane.position.y = lastY;
                plane.position.z = -1;
            }

            // Button-Adder für Opinions
            var addOpinion = function (j) {


                //
                // Scattert Panel für Opinions
                var panelOpinion = new BABYLON.GUI.ScatterPanel();
                uiManager.addControl(panelOpinion);
                panelOpinion.margin = 0.5;
                panelOpinion.linkToTransformNode(anchor);
                // Ausrichten zulassen oder  blocken
                panelOpinion.blockLayout = false;
                // Koordinaten
                panelOpinion.position.x = lastX;
                panelOpinion.position.y = lastY;
                panelOpinion.position.z = (Math.random(150)) + 1;
                panelOpinion.size = Math.random(1);

                // Topic BUTTON
                var butOpinion = new BABYLON.GUI.Button3D("butOpinion");
                var text = new BABYLON.GUI.TextBlock();
                text.text = " T: " + i + " O: " + (j + 1);
                text.color = "red";
                text.fontSize = 40;
                butOpinion.content = text;

                if (j % 2 == 0) {
                    butOpinion.imageUrl = "picture01.png";
                } else {
                    butOpinion.imageUrl = "picture02.png";
                }
                panelOpinion.addControl(butOpinion);
            }

            // durch Topics iterieren
            for (i = 0; i < opinionanzahl.length; i++) {
                addTopic(i);
                //
                // durch Opinions iterieren
                j = 0;
                if (opinionanzahl[i] > 0) {
                    for (j = 0; j <= (i - 1); j++) {
                        addOpinion(j);
                    }
                }
            }

            // 2D GUI für input, tastatur, etc....
            var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("GUI");

            // Input (linksoben)
            var input = new BABYLON.GUI.InputText();
            input.width = 0.2;
            input.maxWidth = 0.2;
            input.height = "40px";
            input.text = "Click here to start typing!";
            input.color = "white";
            input.background = "gray";
            input.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            input.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            advancedTexture.addControl(input);

            // Tastatur (bottom, midde)
            var keyboard = BABYLON.GUI.VirtualKeyboard.CreateDefaultLayout();
            keyboard.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            advancedTexture.addControl(keyboard);
            keyboard.connect(input);

            //
            // show must go on!! Return all this s**t!
            return scene;
        };

        // Create!
        var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
        var scene = createScene();

        // Render, Scene, render!!! 
        engine.runRenderLoop(function () {
            if (scene) {
                scene.render();
            }
        });

        // Resize Listener : Hello Window?!: How is your size?
        window.addEventListener("resize", function () {
            engine.resize();
        });

    </script>
</body>

</html>