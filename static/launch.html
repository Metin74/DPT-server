<!doctype html>
<html>
	<head>
		<title></title>
		<style>
			i {font-style: italic; color: #4a624a; }
			a { color: #fd0; text-decoration: none; }
			body {
				background: #0a120a;
				color: #fee;
				font-family: sans;
			}
		</style>
	</head>
	<body>
	<div id="main"></div>
	<div id="misc"></div>
	</body>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="dpt-client.js"></script>
	<script>

		var currentTopic = 0;
		var whoami = { dptUUID: '', user: {}};
		jQuery(document).ready(function() {
			var socket = io.connect(window.location.protocol
				+ '//' + window.location.host, {transports: ['websocket']});

			var dpt = new DPT(socket);
			var restObj = {};

			// make links triggers for api calls
			function linkHandler() {

				// first and foremost, we need to remove all old event hooks
				jQuery("a.opinionlist").off("click");

				// and then implement the new ones
				jQuery("a.opinionlist").click(function( event ) {
					event.preventDefault();
					dpt.getOpinionByTopic(this.id);
					// the clicked link sets the new current topic.
					currentTopic = this.id;
					return(false);
				});

			}
			
			function phraseForm(dptUUID) {
				jQuery('#misc').append('<div style="position: absolute; padding: 10px; left: 37%;'
						+'border: #fff; border-style: solid; border-width: 5px; background: #0a120a;" id="phrase">'
						+'This device seems not registered, yet.<br>'
						+'Please enter your phrase:<br><form id="phrase">'
						+'<input type="text" name="phrase" size="50" class="phrase"></form></div>');

				jQuery(".phrase").focus();

				jQuery("#phrase").submit(function(event) {
					dpt.userReclaim(jQuery('.phrase').val(), dptUUID);
					jQuery('.phrase').val('');
					event.preventDefault();
				});
			}
			
			function propositionForm(opinionId) {
				jQuery('#misc').append('<div style="position: absolute; padding: 10px; left: 37%;'
						+'border: #fff; border-style: solid; border-width: 5px; background: #0a120a;" id="proposition">'
						+'Please enter your proposition:<br><form id="proposition">'
						+'<input type="text" name="proposition" size="50" class="proposition">'
						+'<input type="hidden" id="opinionId" name="opinionId" value="'+opinionId+'"</form></div>');

				jQuery(".proposition").focus();
				
				jQuery(document).on('submit', 'form#proposition', function(event) {
					event.stopImmediatePropagation();
					var proposition = jQuery('.proposition').val();
					var opinionId = jQuery('#opinionId').val();
					if(proposition) {
						dpt.postDialog(proposition, whoami.dptUUID, opinionId);
					}
					jQuery('.proposition').val('');
					jQuery('#misc').empty();
					event.preventDefault();
					return(0);
				});
			}


			jQuery(document).on('click', 'span.inviteToDialog', function(event) {
				propositionForm(this.id);
				event.stopImmediatePropagation();
				event.preventDefault();
			});


			jQuery(document).on("submit", "form.newTopic", function(event) {
				dpt.putTopic(this[0].value, this.parentNode.nextElementSibling.id);
				event.stopImmediatePropagation();
				event.preventDefault();
			});

			function topicEdit() {
				jQuery('.editTopic').click(function(event) {
					jQuery(this).prev('a').html(
							'<form class="newTopic">'
							+ '<input type="text" value="'
							+  this.previousElementSibling.innerText
							+ '" name="newTopic">'
							+'</form>'
					);
					event.preventDefault();
				});
			}
			
			function topicForm() {
				jQuery('div.col.left').append(
					'<br><hr style="border-color: #5a825a; border-style: solid;">Your topic:<br><form id="newTopic">'
					+'<input class="anewtopic" type=text size=50 name="newTopic"></form>'
				);
				jQuery("#newTopic").submit(function(event) {
					dpt.postTopic(jQuery('.anewtopic').val());
					jQuery('.anewtopic').val('');
					event.preventDefault();
				});
			}

			function opinionForm() {
				jQuery('div.col.mid').append(
					'<br><hr style="border-color: #5a825a; border-style: solid;">Your opinion:<br><form id="newOpinion">'
					+'<input class="anewopinion" type=text size=50 name="newOpinion"></form>'
				);
				jQuery("#newOpinion").submit(function(event) {
					event.preventDefault();
					dpt.postOpinion(currentTopic, jQuery('.anewopinion').val());
					jQuery('.anewopinion').val('');
					event.preventDefault();
				});
			}

			jQuery('#main').height("100%").width("100%")
			.append('<div style="border-bottom-style: solid; border-bottom-width: 5px; border-color: #5a825a;">'
					+'<h1 style="letter-spacing: 30px">version 0.1</h1></div><div class="row">'
					+'<div class="col left"><h2>Topics</h2></div>'
					+'<div class="col mid"><h2>Opinions</h2></div>'
					+'<div class="col right"><h2>Dialogs</h2></div></div>');
			jQuery('div.col').css({float: "left", 'padding-left': "20px", height: "100%", 'overflow-y': "auto"});
 			jQuery('div.col').css({ width: "30%", "max-width": "30%"});
			jQuery('div.row:after').css({content: "", display: "table", clear: "both"});

			socket.on('connect', () => {
				// if needed, we can keep socket.id somewhere
				if(document.cookie) {
					dpt.userLogin(document.cookie);
				}
			});
				
			socket.on('kanal', function(msg) {
				jQuery('#messages').append(jQuery('<li>').text(msg.username +": "+msg.message));
				window.scrollTo(0, document.body.scrollHeight);
			});

			socket.on('update', function(restObj){

			    if(restObj.method == 'post') {
			        if(restObj.path == '/info/') {

						jQuery('#messages')
						.append(jQuery('<li>')
						.text(restObj.data.message));

						window.scrollTo(0, document.body.scrollHeight);
			        }
			    }

		        if(restObj.path == '/topic/' && restObj.method == 'get') {
		        	dpt.getTopic();
		        }

		        if(restObj.path == '/dialog/' && restObj.method == 'get') {
		        	dpt.getDialog();
		        }

		        if(restObj.path.startsWith('/opinion/')
		        && restObj.data.id == currentTopic
		        && restObj.method == 'get') {
		        	dpt.getOpinionByTopic(currentTopic);
		        }
			});
			
			jQuery(document).on("submit", "form.newOpinion", function(event) {
				dpt.putOpinion(whoami.dptUUID, this.parentNode.nextElementSibling.id, currentTopic, this[0].value);
				event.preventDefault();
			});

			function opinionEdit() {
				jQuery('.editOpinion').click(function(event) {
					jQuery(this).prev('span').html(
							'<form class="newOpinion">'
							+ '<input type="text" value="'
							+  this.previousElementSibling.innerText
							+ '" name="newOpinion">'
							+'</form>'
					);
					event.preventDefault();
				});
			}

			jQuery(document).on('mouseover', '.dialog', (event) => {
				jQuery(event.currentTarget).css({"background-color": "#1a221a"});
				jQuery(event.currentTarget.children[2]).css({"visibility": "visible", "line-height": "100%"});
				event.preventDefault();
			});

			jQuery(document).on('mouseout', '.dialog', (event) => {
				jQuery(event.currentTarget).css({"background-color": "#0a120a"});
				jQuery(event.currentTarget.children[2]).css({"visibility": "hidden", "line-height": "0%"});
				event.preventDefault();
			});
			
			socket.on('api', function(restObj) {
				if(!restObj) {
					return;
				}
				
				if(restObj.path == '/dialog/'
				&& restObj.method == 'get') {
					console.log(restObj.data);
					var dialog = '';
					var dialogs = restObj.data.data;
					jQuery('div.col.right').html('<h2>Dialogs</h2>');
					for(var i=0; i < dialogs.length; i++) {
						dialog = '<div class="dialog"><i>proposition:</i> '+dialogs[i].opinionProposition+"<br>";
						dialog += '<div class="hide"><i>topic:</i> '+dialogs[i].topic+"<br>";
						if(dialogs[i].initiator == 'me') {
							dialog += "<i>my opinion:</i> "+dialogs[i].initiatorOpinion+"<br>";
							dialog += "<i>other's opinion:</i> "+dialogs[i].recipientOpinion+"<br>";
							dialog += "<i>initiator:</i> me ";
						} else {
							dialog += "<i>my opinion:</i> "+dialogs[i].recipientOpinion+"<br>";
							dialog += "<i>other's opinion:</i> "+dialogs[i].initiatorOpinion+"<br>";
							dialog += "<i>initiator:</i> other ";
						}
						dialog += "<i>status:</i> "+dialogs[i].status+"</div>";
						jQuery('div.col.right').append(dialog+"<br></div>");
						jQuery('.hide').css({"visibility": "hidden", "line-height": "0%"});
					}
				}
						

				if(restObj.path == '/topic/') {
					jQuery('div.col.left').html('<h2>Topics</h2>');
					var i;
					var options = '';
					for (i in restObj.data) {
						if(restObj.data[i].user == 'mine') {
							options = '<span class="editTopic" id="'
									+ restObj.data[i]._id
									+ '">&#128393;</span>';
						} else {
							options = '';
						}
						jQuery('div.col.left').append(
							'<li> <a class="opinionlist" id="'
							+restObj.data[i]._id
							+'" href="#">'
							+restObj.data[i].content
							+"</a>"+options+"</li><br>");
					}
					topicEdit();
					topicForm();

				} else if(restObj.path.startsWith("/opinion/"+currentTopic+"/")) {

					var i;
					var options = '';

					jQuery('div.col.mid').html('<h2>Opinions</h2>');

					for (i in restObj.data) {

						if(restObj.data[i].user == 'mine') {
							options = '<span class="editOpinion" id="'
							+ restObj.data[i]._id
							+ '">&#128393;</span>';
						} else {
							options = '<span class="inviteToDialog" id="'
							+ restObj.data[i]._id
							+ '">'
							+ '&#128172;'
							+ '</span>';
						}

						jQuery('div.col.mid')
						.append('<li><span class="text">'
						+restObj.data[i].content
							+ "</span> " +options+ "</li><br>");
					}

					if(restObj.data.length > 0) {
						dpt.opinionPostAllowed(restObj.data[0].topic);
					} else {
						opinionForm();
					}
					opinionEdit();

				} else if(restObj.path == '/opinion/postAllowed/' && restObj.data.value == true) {

					opinionForm();

				} else if(restObj.path == '/user/reclaim/'+ whoami.dptUUID +'/') {

					if(restObj.data.newCookie) {
						document.cookie = "dptUUID="+restObj.data.newCookie+"; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/;"; 
						location.reload();
					} else {
						console.log("special treadment, new account?!");
					}

				}

				linkHandler();
			});

			socket.on('private', function(restObj) {
			    if(restObj.method == 'post') {
			        if(restObj.path == '/info/') {
			        	whoami.dptUUID = restObj.data.dptUUID;
			        	if(restObj.data.message == 'logged in') {
			        		whoami.user = restObj.data.user;
			        		dpt.getTopic();
			        		dpt.getDialog();
			        	}
						if(restObj.data.message == 'user unknown') {
							whoami.user = {};
							phraseForm(restObj.data.dptUUID);
						} else {
							jQuery('#messages').append(jQuery('<li>').text(restObj.data.message));
							window.scrollTo(0, document.body.scrollHeight);
			        	}
			        }
			    }
			});
			socket.on('error', function (e) {
				console.log('System', e ? e : 'A unknown error occurred');
				document.location.reload(true);
				window.location.reload(true);
			});

			jQuery('form').submit(function(){
				socket.emit('kanal', jQuery('#m').val());
				jQuery('#m').val('');
				return false;
			});

/*
			io('connection_timeout', function() {
				console.log('connection_timeout');
			});
			io('connection_error', function(e) {
				console.log('connection_error', e ? e : 'A unknown error occurred');
			});
			io('reconnect_error', function(e) {
				console.log('reconnect_error', e ? e : 'A unknown error occurred');
			});
			io('reconnect_attempt', function(n) {
				console.log('reconnect attempt: '+n);
			});
			io('reconnect_failed', function() {
				console.log('reconnect failed');
			});
			io('reconnect', function() {
				console.log('successful reconnected');
			});
			io('reconnect', function(n) {
				console.log('try to reconnect '+n);
			});
*/
		});
	</script>
</html>  
